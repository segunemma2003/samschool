name: Update Compasse Application

on:
  push:
    branches: [main]

jobs:
  update:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy Updates to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 600s
          script: |
            set -e

            echo "ğŸš€ Starting application update..."

            # Navigate to application directory
            cd /var/www/compasse

            # Create quick backup
            BACKUP_DIR="/var/www/compasse_backup_$(date +%Y%m%d_%H%M%S)"
            echo "ğŸ’¾ Creating backup..."
            sudo cp -r /var/www/compasse $BACKUP_DIR
            echo "âœ… Backup created: $BACKUP_DIR"

            # Put application in maintenance mode
            echo "ğŸ”§ Enabling maintenance mode..."
            php artisan down --retry=60 --refresh=15 || echo "Could not enable maintenance mode"

            # Pull latest changes from GitHub
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            echo "âœ… Code updated successfully"

            # Update Composer dependencies
            echo "ğŸ“¦ Updating dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            composer dump-autoload --optimize
            echo "âœ… Dependencies updated"

            # Run database migrations
            echo "ğŸ”„ Running database migrations..."
            php artisan migrate --force
            echo "âœ… Migrations completed"

            # Run tenant migrations
            echo "ğŸ”„ Running tenant migrations..."
            php artisan tenants:migrate --force || echo "No tenant migrations to run"
            echo "âœ… Tenant migrations completed"

            # Clear and cache configurations (SKIP ROUTE CACHING)
            echo "ğŸ§¹ Clearing and caching configurations..."
            php artisan optimize:clear
            php artisan config:cache
            # php artisan route:cache  # <-- COMMENTED OUT TO IGNORE THE ERROR
            php artisan view:cache
            echo "âœ… Configurations cached (routes skipped)"

            # Restart queue workers
            echo "ğŸ”„ Restarting queue workers..."
            php artisan queue:restart
            if sudo supervisorctl status | grep -q "compasse-worker"; then
              sudo supervisorctl restart compasse-worker:*
            fi
            echo "âœ… Queue workers restarted"

            # Restart PHP-FPM
            echo "ğŸ”„ Restarting PHP-FPM..."
            sudo systemctl reload php8.4-fpm || echo "Could not reload PHP-FPM"
            echo "âœ… PHP-FPM reloaded"

            # Take application out of maintenance mode
            echo "ğŸŸ¢ Disabling maintenance mode..."
            php artisan up
            echo "âœ… Application is now live"

            # Clean up old backups (keep last 5)
            echo "ğŸ§¹ Cleaning up old backups..."
            ls -td /var/www/compasse_backup_* | tail -n +6 | xargs -r rm -rf
            echo "âœ… Old backups cleaned"

            echo ""
            echo "ğŸ‰ Application update completed successfully!"
            echo "ğŸ“Š Summary:"
            echo "  âœ… Code pulled from GitHub"
            echo "  âœ… Dependencies updated"
            echo "  âœ… Database migrations run"
            echo "  âœ… Tenant migrations run"
            echo "  âœ… Configurations cached (routes skipped for stability)"
            echo "  âœ… Queue workers restarted"
            echo "  âœ… Application is live"
            echo ""
            echo "ğŸ”— Visit your site to verify the update!"

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_USER }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "âŒ Update failed! Starting automatic rollback..."

            # Find the latest backup
            LATEST_BACKUP=$(ls -td /var/www/compasse_backup_* 2>/dev/null | head -n1)

            if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
              echo "ğŸ“¦ Rolling back to: $LATEST_BACKUP"

              # Stop queue workers
              if sudo supervisorctl status | grep -q "compasse-worker"; then
                sudo supervisorctl stop compasse-worker:* || true
              fi

              # Restore from backup
              sudo rm -rf /var/www/compasse
              sudo cp -r $LATEST_BACKUP /var/www/compasse

              # Fix permissions
              sudo chown -R www-data:www-data /var/www/compasse/storage /var/www/compasse/bootstrap/cache
              sudo chown -R $USER:$USER /var/www/compasse

              # Restart services
              cd /var/www/compasse
              php artisan up || true
              if sudo supervisorctl status | grep -q "compasse-worker"; then
                sudo supervisorctl start compasse-worker:* || true
              fi
              sudo systemctl reload php8.4-fpm || true

              echo "âœ… Automatic rollback completed!"
              echo "ğŸ”— Your previous version is now restored and live"
            else
              echo "âŒ No backup found for rollback!"
              echo "ğŸš¨ Manual intervention required"
            fi

      - name: Notify Success
        if: success()
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸš€ Application has been updated and is running the latest code"
          echo "ğŸ“… Deployed at: $(date)"
          echo "ğŸ“Š Commit: ${{ github.sha }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "âŒ Deployment failed!"
          echo "ğŸ”„ Automatic rollback should have restored the previous version"
          echo "ğŸ“… Failed at: $(date)"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸš¨ Please check the server logs for details"
