name: Deploy Compasse (Main Branch)

on:
  push:
    branches: [main]

env:
  PHP_VERSION: "8.3"

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy environment file
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run database migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root

      - name: Run tests
        run: php artisan test
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 1800s
          script: |
            set -e

            echo "ðŸš€ Starting Compasse deployment..."

            # Variables
            REPO_URL="https://github.com/segunemma2003/samschool.git"
            APP_DIR="/var/www/compasse"
            BRANCH="main"

            # Create backup
            if [ -d "$APP_DIR" ] && [ "$(ls -A $APP_DIR)" ]; then
              BACKUP_DIR="/var/www/compasse_backup_$(date +%Y%m%d_%H%M%S)"
              echo "ðŸ’¾ Creating backup..."
              sudo cp -r $APP_DIR $BACKUP_DIR

              # Backup database
              if [ -f "$APP_DIR/.env" ]; then
                DB_NAME="${{ secrets.COMPASSE_DB_DATABASE }}"
                DB_USER="${{ secrets.COMPASSE_DB_USERNAME }}"
                DB_PASS="${{ secrets.COMPASSE_DB_PASSWORD }}"

                echo "ðŸ’¾ Creating database backup..."
                mysqldump -h${{ secrets.COMPASSE_DB_HOST }} -u$DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/database_backup.sql

                # Upload to S3
                aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
                aws configure set default.region ${{ secrets.AWS_DEFAULT_REGION }}
              fi
            fi

            # Setup application directory
            sudo mkdir -p $APP_DIR
            sudo chown -R $USER:$USER $APP_DIR

            # Clone or update repository
            if [ -d "$APP_DIR/.git" ]; then
              echo "ðŸ“¥ Updating repository..."
              cd $APP_DIR
              git fetch --all
              git reset --hard origin/$BRANCH
              git clean -fd
            else
              echo "ðŸ“¥ Cloning repository..."
              if [ "$(ls -A $APP_DIR 2>/dev/null)" ]; then
                rm -rf $APP_DIR/*
              fi
              git clone -b $BRANCH $REPO_URL $APP_DIR
              cd $APP_DIR
            fi

            # Install dependencies
            echo "ðŸ“¦ Installing dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev

            # Configure environment
            echo "ðŸ”§ Configuring environment..."
            if [ ! -f ".env" ]; then
              cp .env.example .env
              php artisan key:generate --force
            fi

            # Update environment variables


            # Create storage directories
            mkdir -p storage/{app,framework/{cache,sessions,views},logs}
            mkdir -p bootstrap/cache

            # Put in maintenance mode
            php artisan down --retry=60 || echo "Could not put in maintenance mode"

            # Run migrations
            echo "ðŸ”„ Running migrations..."
            php artisan migrate --force
            php artisan tenants:migrate --force || echo "No tenant migrations"

            # Clear and cache
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

            # Set permissions
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            # Restart services
            sudo supervisorctl restart compasse-worker:* || echo "Supervisor restart failed"
            sudo systemctl reload nginx

            # Take out of maintenance mode
            php artisan up

            echo "âœ… Compasse deployment completed!"
