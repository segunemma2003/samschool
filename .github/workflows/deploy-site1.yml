name: Update Compasse Application

on:
  push:
    branches: [main]

jobs:
  update:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deploy Updates to Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 600s
          script: |
            set -e

            echo "🚀 Starting application update..."

            # Navigate to application directory
            cd /var/www/compasse

            # Create quick backup
            BACKUP_DIR="/var/www/compasse_backup_$(date +%Y%m%d_%H%M%S)"
            echo "💾 Creating backup..."
            sudo cp -r /var/www/compasse $BACKUP_DIR
            echo "✅ Backup created: $BACKUP_DIR"

            # Put application in maintenance mode
            echo "🔧 Enabling maintenance mode..."
            php artisan down --retry=60 --refresh=15 || echo "Could not enable maintenance mode"

            # Pull latest changes from GitHub
            echo "📥 Pulling latest changes..."
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            echo "✅ Code updated successfully"

            # Update Composer dependencies
            echo "📦 Updating dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            composer dump-autoload --optimize
            echo "✅ Dependencies updated"

            # Run database migrations
            echo "🔄 Running database migrations..."
            php artisan migrate --force
            echo "✅ Migrations completed"

            # Run tenant migrations
            echo "🔄 Running tenant migrations..."
            php artisan tenants:migrate --force || echo "No tenant migrations to run"
            echo "✅ Tenant migrations completed"

            # Clear and cache configurations (SKIP ROUTE CACHING)
            echo "🧹 Clearing and caching configurations..."
            php artisan optimize:clear
            php artisan config:cache
            # php artisan route:cache  # <-- COMMENTED OUT TO IGNORE THE ERROR
            php artisan view:cache
            echo "✅ Configurations cached (routes skipped)"

            # Restart queue workers
            echo "🔄 Restarting queue workers..."
            php artisan queue:restart
            if sudo supervisorctl status | grep -q "compasse-worker"; then
              sudo supervisorctl restart compasse-worker:*
            fi
            echo "✅ Queue workers restarted"

            # Restart PHP-FPM
            echo "🔄 Restarting PHP-FPM..."
            sudo systemctl reload php8.4-fpm || echo "Could not reload PHP-FPM"
            echo "✅ PHP-FPM reloaded"

            # Take application out of maintenance mode
            echo "🟢 Disabling maintenance mode..."
            php artisan up
            echo "✅ Application is now live"

            # Clean up old backups (keep last 5)
            echo "🧹 Cleaning up old backups..."
            ls -td /var/www/compasse_backup_* | tail -n +6 | xargs -r rm -rf
            echo "✅ Old backups cleaned"

            echo ""
            echo "🎉 Application update completed successfully!"
            echo "📊 Summary:"
            echo "  ✅ Code pulled from GitHub"
            echo "  ✅ Dependencies updated"
            echo "  ✅ Database migrations run"
            echo "  ✅ Tenant migrations run"
            echo "  ✅ Configurations cached (routes skipped for stability)"
            echo "  ✅ Queue workers restarted"
            echo "  ✅ Application is live"
            echo ""
            echo "🔗 Visit your site to verify the update!"

      - name: Rollback on Failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_USER }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "❌ Update failed! Starting automatic rollback..."

            # Find the latest backup
            LATEST_BACKUP=$(ls -td /var/www/compasse_backup_* 2>/dev/null | head -n1)

            if [ -n "$LATEST_BACKUP" ] && [ -d "$LATEST_BACKUP" ]; then
              echo "📦 Rolling back to: $LATEST_BACKUP"

              # Stop queue workers
              if sudo supervisorctl status | grep -q "compasse-worker"; then
                sudo supervisorctl stop compasse-worker:* || true
              fi

              # Restore from backup
              sudo rm -rf /var/www/compasse
              sudo cp -r $LATEST_BACKUP /var/www/compasse

              # Fix permissions
              sudo chown -R www-data:www-data /var/www/compasse/storage /var/www/compasse/bootstrap/cache
              sudo chown -R $USER:$USER /var/www/compasse

              # Restart services
              cd /var/www/compasse
              php artisan up || true
              if sudo supervisorctl status | grep -q "compasse-worker"; then
                sudo supervisorctl start compasse-worker:* || true
              fi
              sudo systemctl reload php8.4-fpm || true

              echo "✅ Automatic rollback completed!"
              echo "🔗 Your previous version is now restored and live"
            else
              echo "❌ No backup found for rollback!"
              echo "🚨 Manual intervention required"
            fi

      - name: Notify Success
        if: success()
        run: |
          echo "✅ Deployment successful!"
          echo "🚀 Application has been updated and is running the latest code"
          echo "📅 Deployed at: $(date)"
          echo "📊 Commit: ${{ github.sha }}"

      - name: Notify Failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          echo "🔄 Automatic rollback should have restored the previous version"
          echo "📅 Failed at: $(date)"
          echo "📊 Commit: ${{ github.sha }}"
          echo "🚨 Please check the server logs for details"
