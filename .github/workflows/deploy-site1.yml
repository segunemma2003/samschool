name: Deploy Compasse (Main Branch) - First Push

on:
  push:
    branches: [main]

env:
  PHP_VERSION: "8.3"

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: testing
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3
        ports:
          - 3306:3306

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: dom, curl, libxml, mbstring, zip, pcntl, pdo, sqlite, pdo_sqlite, bcmath, soap, intl, gd, exif, iconv

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist --optimize-autoloader

      - name: Copy environment file
        run: cp .env.example .env

      - name: Generate application key
        run: php artisan key:generate

      - name: Run database migrations
        run: php artisan migrate --force
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root

      - name: Run tests
        run: php artisan test
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: testing
          DB_USERNAME: root
          DB_PASSWORD: root

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Deploy to Production Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 1800s
          script: |
            set -e

            echo "ðŸš€ Starting Compasse deployment (First Push)..."

            # Variables
            REPO_URL="https://github.com/segunemma2003/samschool.git"
            APP_DIR="/var/www/compasse"
            BRANCH="main"

            # Create backup only if directory exists and has content
            if [ -d "$APP_DIR" ] && [ "$(ls -A $APP_DIR 2>/dev/null)" ]; then
              BACKUP_DIR="/var/www/compasse_backup_$(date +%Y%m%d_%H%M%S)"
              echo "ðŸ’¾ Creating backup of existing installation..."
              sudo cp -r $APP_DIR $BACKUP_DIR
              echo "âœ… Backup created at: $BACKUP_DIR"
            else
              echo "â„¹ï¸  No existing installation found - this appears to be first deployment"
            fi

            # Setup application directory
            sudo mkdir -p $APP_DIR
            sudo chown -R $USER:$USER $APP_DIR

            # Clone or update repository
            if [ -d "$APP_DIR/.git" ]; then
              echo "ðŸ“¥ Updating existing repository..."
              cd $APP_DIR
              git fetch --all
              git reset --hard origin/$BRANCH
              git clean -fd
            else
              echo "ðŸ“¥ Cloning repository for first time..."
              # Clear directory if it has any files
              if [ "$(ls -A $APP_DIR 2>/dev/null)" ]; then
                rm -rf $APP_DIR/*
              fi
              git clone -b $BRANCH $REPO_URL $APP_DIR
              cd $APP_DIR
              echo "âœ… Repository cloned successfully"
            fi

            # Install dependencies
            echo "ðŸ“¦ Installing Composer dependencies..."
            composer install --no-interaction --prefer-dist --optimize-autoloader --no-dev
            echo "âœ… Dependencies installed"

            # Environment configuration - Manual setup message
            echo "ðŸ”§ Checking environment configuration..."
            if [ ! -f ".env" ]; then
              echo "ðŸ“‹ Creating .env file from example..."
              cp .env.example .env
              echo "âš ï¸  IMPORTANT: You need to manually configure your .env file!"
              echo "âš ï¸  Please SSH into the server and edit /var/www/compasse/.env"
              echo "âš ï¸  Set your database credentials, S3 settings, and other configurations"
              echo "âš ï¸  Then run: php artisan key:generate"
            else
              echo "âœ… .env file already exists - keeping your manual configuration"
            fi

            # Generate app key if not set
            if ! grep -q "APP_KEY=base64:" .env; then
              echo "ðŸ”‘ Generating application key..."
              php artisan key:generate --force
              echo "âœ… Application key generated"
            else
              echo "âœ… Application key already exists"
            fi

            # Create required storage directories
            echo "ðŸ“ Creating storage directories..."
            mkdir -p storage/{app,framework/{cache,sessions,views},logs}
            mkdir -p bootstrap/cache
            echo "âœ… Storage directories created"

            # Check if we can connect to database before proceeding
            echo "ðŸ” Checking database connection..."
            if php artisan migrate:status > /dev/null 2>&1; then
              echo "âœ… Database connection successful"

              # Put in maintenance mode (only if not first deployment)
              if [ -f "storage/framework/down" ] || [ -f "bootstrap/cache/config.php" ]; then
                php artisan down --retry=60 || echo "Could not put in maintenance mode"
              fi

              # Run migrations
              echo "ðŸ”„ Running migrations..."
              php artisan migrate --force

              # Run tenant migrations if available
              php artisan tenants:migrate --force || echo "No tenant migrations found"

              echo "âœ… Migrations completed"
            else
              echo "âš ï¸  Database connection failed - skipping migrations"
              echo "âš ï¸  Please configure your .env file with correct database settings"
              echo "âš ï¸  Then manually run: php artisan migrate --force"
            fi

            # Clear and cache configurations (only if database is connected)
            echo "ðŸ§¹ Clearing and caching configurations..."
            php artisan optimize:clear || echo "Optimize clear failed - this is normal for first deployment"

            # Only cache if database connection works
            if php artisan migrate:status > /dev/null 2>&1; then
              php artisan config:cache || echo "Config cache failed"
              php artisan route:cache || echo "Route cache failed"
              php artisan view:cache || echo "View cache failed"
              echo "âœ… Configurations cached"
            else
              echo "âš ï¸  Skipping configuration caching due to database connection issues"
            fi

            # Set proper permissions
            echo "ðŸ”’ Setting file permissions..."
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            sudo chown -R $USER:$USER $APP_DIR
            echo "âœ… Permissions set"

            # Install or restart supervisor workers (create config if not exists)
            echo "âš™ï¸  Configuring supervisor workers..."
            if [ ! -f "/etc/supervisor/conf.d/compasse-worker.conf" ]; then
              echo "ðŸ“ Creating supervisor configuration..."
              sudo tee /etc/supervisor/conf.d/compasse-worker.conf > /dev/null <<EOF
            [program:compasse-worker]
            process_name=%(program_name)s_%(process_num)02d
            command=php $APP_DIR/artisan queue:work --sleep=3 --tries=3 --max-time=3600
            autostart=true
            autorestart=true
            stopasgroup=true
            killasgroup=true
            user=www-data
            numprocs=2
            redirect_stderr=true
            stdout_logfile=$APP_DIR/storage/logs/worker.log
            stopwaitsecs=3600
            EOF
              sudo supervisorctl reread
              sudo supervisorctl update
              echo "âœ… Supervisor configuration created"
            fi

            sudo supervisorctl restart compasse-worker:* || echo "Supervisor restart failed - may not be configured yet"

            # Reload Nginx
            echo "ðŸ”„ Reloading Nginx..."
            sudo nginx -t && sudo systemctl reload nginx || echo "Nginx reload failed - please check configuration"

            # Take out of maintenance mode
            if [ -f "storage/framework/down" ]; then
              php artisan up || echo "Could not take out of maintenance mode"
              echo "âœ… Application is now live"
            fi

            echo ""
            echo "ðŸŽ‰ Compasse deployment completed!"
            echo ""
            echo "ðŸ“‹ NEXT STEPS (IMPORTANT):"
            echo "1. SSH into your server: ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}"
            echo "2. Edit your .env file: nano /var/www/compasse/.env"
            echo "3. Configure your database settings, S3 credentials, etc."
            echo "4. Run migrations: cd /var/www/compasse && php artisan migrate --force"
            echo "5. Run tenant migrations: php artisan tenants:migrate --force"
            echo "6. Test your application: visit your domain"
            echo ""
            echo "ðŸ’¡ Your application files are deployed at: /var/www/compasse"
            echo "ðŸ’¡ Logs are available at: /var/www/compasse/storage/logs/"
